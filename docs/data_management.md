# Data Management

Flexiznam provides utilities to detect data and create the corresponding flexilims entities. 

## Usage

### Acquisition

This will work only if the acquisition pipeline works as predicted, that means that at acquisition:

*  files are named automatically
*  scanimage creates a directory for each recording
*  file names are: `MOUSE_SESSION_RECORDING_PROTOCOL`
*  all path are relative to `DATAROOT`: `<DATAROOT>/<MOUSE>/<SESSION>/<RECORDING_PROTOCOL>/...`

### YAML file

The starting point is a YAML file. An example minimal file is in `flexiznam/flexiznam/camp/minimal_acquisition_yaml_example.yml`. A detailed example showing all
optional features called `acquisition_yaml_example.yml` can be found in the same folder.

Briefly the YAML file format is:

```
project: <PROJECT>
mouse: <MOUSE>
session: <SESSION>
notes: "optional notes"
recordings:
  <RECORDING>:
    protocol: protocol_name
    timestamp: [optional, in HHMMSS]
    notes: [optional]
    datasets: [optional]
      <DATASET>: [optional]
        type: dataset type (scanimage for instance)
        path: path to the folder containing the dataset
```

This YAML file must be saved in the session folder. The mouse folder must be named like the mouse, the session folder like the session and the 
recording folder like the recording.

### File transfer

File transfer is not handled by flexiznam. You should transfer all the data to CAMP first. We will just check that it is available. The path to the camp folder containing the projects must be set in the config file.

The best way to transfer files from a windows computer might be to use [`robocopy`](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy). Mount the CAMP drive and just do:

```
robocopy <SOURCE_FOLDER> <DESTINATION> /e /z
```

With `/e` to copy recursively, including empty directory and `/z` to use restartable mode (in case connection is lost)

You can also consider: 
- `/j` to copy using unbuffered I/O (recommended for large files). 
- `/copy:DAT` to copy data, attributes and timestamps but not ownership or ACL.
- `/move` to move instead of copying (delete after successful upload)

### Validating the YAML

Once the data is on CAMP, the first step is to validate and autopopulate the YAML. 

`flexiznam process-yaml --source_yaml "path/to/acq_yaml.yml"`

This will create a local copy of the yml called `acq_yaml_autogenerated_full_file.yml`. If a dataset cannot be located or loaded, the yaml file with contain a warning starting with `XXERRORXX`. A list of such errors will also be printed on the console. Here is for instance an example output:

```
Reading example_acquisition_yaml.yml

Found some issues with the yaml:
    - Dataset: `ref_for_motion`
              Could not find dataset "ref_for_motion". Found "PZAH4.1c_S20210513_R181858_SphereCylinder00001, PZAH4.1c_S20210513_R182025_SphereCylinder00001, PZAH4.1c_S20210513_R182758_SphereCylinder00001" instead
    - Dataset: `overview_picture_02`
              Could not find dataset "overview_picture_02". Found "overview00001, overview00002" instead
    - Dataset: `harp_data_csv`
              Dataset not found. Path /Volumes/lab-znamenskiyp/home/shared/projects/3d_vision/Data/ParamLog/R193432_Retinotopy does not exist
Fix manually these errors before uploading to flexilims
Processed yaml saved to example_acquisition_yaml_autogenerated_full_file.yml
```

Before uploading, one must then manually edit the yaml to fix it. You can call `process-yaml` on the fixed yaml until there is no error.

### Upload to flexilims

The project and the mouse must already exist on flexlims. You can create the project manually from the web interface (and then add its ID to your config file in `~/.flexiznam/config.yml`. The mouse can be added via the web interface or using `flexiznam add-mouse`.
